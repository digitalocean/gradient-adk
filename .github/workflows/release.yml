name: Build and Release CLI

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v2.1.0, etc.

jobs:
  build:
    runs-on: prod
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux
            artifact_name: gradient-linux-x86_64
            asset_name: gradient-linux-x86_64
          - os: windows-latest
            target: windows
            artifact_name: gradient-windows-x86_64.exe
            asset_name: gradient-windows-x86_64.exe
          - os: macos-latest
            target: macos
            artifact_name: gradient-macos-x86_64
            asset_name: gradient-macos-x86_64
          - os: macos-14  # M1 runner
            target: macos-arm64
            artifact_name: gradient-macos-arm64
            asset_name: gradient-macos-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .

    - name: Download doctl binaries
      run: |
        chmod +x download_doctl.sh
        ./download_doctl.sh

    - name: Build executable
      run: |
        pyinstaller gradient.spec --distpath dist

    - name: Debug - List created files
      shell: bash
      run: |
        echo "Files in dist directory:"
        ls -la dist/
        echo "Looking for gradient executables:"
        find dist/ -name "*gradient*" -type f

    - name: Rename executable 
      shell: bash
      run: |
        echo "Target: ${{ matrix.target }}"
        echo "Artifact name: ${{ matrix.artifact_name }}"
        
        if [ "${{ matrix.target }}" == "windows" ]; then
          # On Windows, PyInstaller creates .exe regardless of spec name
          if [ -f "dist/gradient.exe" ]; then
            echo "Found dist/gradient.exe, renaming to ${{ matrix.artifact_name }}"
            mv dist/gradient.exe dist/${{ matrix.artifact_name }}
          elif [ -f "dist/gradient" ]; then
            echo "Found dist/gradient, renaming to ${{ matrix.artifact_name }}"
            mv dist/gradient dist/${{ matrix.artifact_name }}
          else
            echo "ERROR: No gradient executable found!"
            echo "Available files in dist/:"
            ls -la dist/
            exit 1
          fi
        else
          # Unix systems
          if [ -f "dist/gradient" ]; then
            echo "Found dist/gradient, renaming to ${{ matrix.artifact_name }}"
            mv dist/gradient dist/${{ matrix.artifact_name }}
          else
            echo "ERROR: No gradient executable found!"
            echo "Available files in dist/:"
            ls -la dist/
            exit 1
          fi
        fi

    - name: Test executable
      shell: bash
      run: |
        chmod +x dist/${{ matrix.artifact_name }} || true
        ./dist/${{ matrix.artifact_name }} --help

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}

  release:
    needs: build
    runs-on: prod
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_SERVER_URL: "github.internal.digitalocean.com"
      GH_HOST: "github.internal.digitalocean.com"


    steps:
      - uses: actions/checkout@v4

      - name: Authenticate gh to GHES
        run: |
          printf "%s" "$GH_TOKEN" | gh auth login \
            --hostname "$GH_HOST" \
            --with-token
          gh auth status --hostname "$GH_HOST"

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Write release notes
        run: |
          cat > release_notes.md <<'EOF'
          ## Gradient CLI ${{ github.ref_name }}

          ### What's New
          - Standalone executables with embedded doctl binary for all platforms
          - No external dependencies required - fully self-contained
          EOF

      - name: Create Release with GitHub CLI
        run: |
          gh release create "${{ github.ref_name }}" \
            --repo "${{ github.repository }}" \
            --title "Gradient CLI ${{ github.ref_name }}" \
            --notes-file release_notes.md \
            gradient-linux-x86_64/gradient-linux-x86_64 \
            gradient-macos-x86_64/gradient-macos-x86_64 \
            gradient-macos-arm64/gradient-macos-arm64 \
            gradient-windows-x86_64.exe/gradient-windows-x86_64.exe